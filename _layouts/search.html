---
layout: default
---
<article id="search">
  {% include header.html %}

    <!-- content -->
  <main style="flex: 3;">
      {{ content }}
  </main>

  <!-- 以下是搜索页面的内容 -->
  <input type="text" id="search-input" placeholder="搜索..." disabled>
  <div id="search-results"></div>
  <div class="progress" id="progress-bar-container" style="display: block;">
    <div class="progress-bar custom-progress-bar" id="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">索引加载中...</div>
  </div>

  <script>
      const worker = new Worker('/assets/js/search/work.js');
      const searchInput = document.getElementById('search-input');
      const searchResults = document.getElementById('search-results');

      worker.addEventListener('message', (event) => {
        const { type, progress, results, message } = event.data;

        switch (type) {
          case 'progress':
            updateProgressBar(progress * 100);
            break;
          case 'ready':
            searchInput.disabled = false;
            break;
          case 'results':
            displayResults(results, event.data.query);
            break;
          case 'error':
            console.error('Worker error:', message);
            break;
          default:
            console.error('Unknown message type from worker');
        }
      });

      // 更新进度条
      function updateProgressBar(progress) {
        const progressBar = document.getElementById('progress-bar');
        progressBar.style.width = progress + '%';
        progressBar.setAttribute('aria-valuenow', progress);
        if (progress === 100) showStatusAndHideProgressBar();
      }

      // 显示提示组件并自动隐藏
      function showStatusAndHideProgressBar() {
        const progressBarContainer = document.getElementById('progress-bar-container');
        const progressBar = document.getElementById('progress-bar');
        progressBar.innerText = '索引加载完成!';
        progressBar.style.background = '#118fbf';
        setTimeout(() => {
          progressBarContainer.style.display = 'none';
        }, 3000); // 3秒后隐藏提示
      }

      fetch('/search.json')
        .then(response => response.json())
        .then(data => {
          worker.postMessage({ type: 'init', data });
          updateProgressBar(10)
        });

      function search(query) {
        worker.postMessage({ type: 'search', data: { query } });
      }

      searchInput.addEventListener('input', function() {
        var query = this.value;
        search(query);
      });

      function displayResults(results, query) {
        searchResults.innerHTML = '';

        if (results.length > 0) {
          results.forEach(function(result) {
            var link = document.createElement('a');
            link.href = result.ref;
            link.innerHTML = '<strong>' + highlight(result.title, query) + '</strong>';
            searchResults.appendChild(link);

            var contentSummary = document.createElement('p');
            contentSummary.innerHTML = highlight(result.content.substring(0, 100), query) + '...';
            searchResults.appendChild(contentSummary);

            searchResults.appendChild(document.createElement('br'));
          });
        } else {
          searchResults.textContent = '没有找到相关结果';
        }
      }

      function highlight(text, query) {
        if (!query) {
          return text;
        }
        var re = new RegExp(query, 'gi');
        return text.replace(re, function(match) {
          return '<span class="search-highlight">' + match + '</span>';
        });
      }
  </script>
</article>
